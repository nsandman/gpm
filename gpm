#!/usr/bin/python
import click
from os import listdir, path, remove
import json
import urllib
from subprocess import call
from shutil import copy

@click.command()
@click.argument('install', nargs=-1, required=True)

def install(install):
	gpmdir = path.expanduser('~') + '/.gpm'
	if install[0] == 'install' or install[0] == 'i':
		for a in range(1, len(install)):
			y = listdir(gpmdir + '/pkg')
			try:
				z = install[a] + '.gpm'
				x = y.index(z)
				click.echo('Package "%s" found, installing...' % install[a])
				m = open(gpmdir + '/pkg/' + z, 'r')
				f = json.loads(m.read())
				p = gpmdir + '/tmp/' + install[a]
				urllib.urlretrieve(f['url'], p) 
				g = f['commands']
				for y in range(len(g)):
					call(g[y].format(FILENAME=p, GPMDIR=gpmdir), shell=True)
				m.close()
				copy(p, gpmdir + '/installed/')
				v = open(gpmdir + '/installed/_installed.gpm', 'a')
				v.write(install[a] + "\n")
				v.close()
				e = gpmdir + '/tmp/'
				for b in listdir(e):
					remove(e + str(b))
			except ValueError:
				click.echo('Package "%s" not found, skipping...' % install[a])
	elif install[0] == 'remove' or install[0] == 'r' or install[0] == 'delete' or install[0] == 'd' or install[0] == 'destroy':
		for a in range(1, len(install)):
			try:
				remove(gpmdir + '/installed/' + install[a])
				v = open(gpmdir + '/installed/_installed.gpm', 'r')
				lines = v.readlines()
				v.close()
				v = open(gpmdir + '/installed/_installed.gpm', 'w')
				for line in lines:
					if line != install[a] + '\n':
						v.write(line)
				v.close()
				click.echo('Package "%s" found, removing...' % install[a])
			except OSError:
				click.echo('Package "%s" not found, skipping...' % install[a])
		click.echo('Done.')
	elif install[0] == 'list':
		v = open(gpmdir + '/installed/_installed.gpm', 'r')
		click.echo('INSTALLED PACKAGES')
		click.echo('==================')
		click.echo(v.read())
		v.close()
if __name__ == '__main__':
	install()